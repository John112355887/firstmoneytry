<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XX è®¡ç®—å™¨åˆé›†</title>
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --accent:#2b7cff;
    --muted:#666;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;background:var(--bg);color:#111;}
  /* ç™»å½•åŒº */
  #loginWrap{height:100vh;display:flex;align-items:center;justify-content:center;}
  .loginBox{background:var(--card);padding:24px;border-radius:12px;box-shadow:0 8px 24px rgba(20,30,60,0.08);width:360px;text-align:center;}
  .loginBox h2{margin:0 0 12px;font-size:20px;}
  .loginBox input{width:100%;padding:10px 12px;margin-top:8px;border:1px solid #e0e6f0;border-radius:8px;font-size:15px;}
  .loginBox .row{display:flex;gap:8px;margin-top:12px;}
  .loginBox button{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;width:100%;}
  .purchaseRow{margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;}
  /* ä¸»ç•Œé¢ */
  .app{display:flex;flex-direction:column;height:100vh;}
  header.appHeader{padding:18px 22px;background:linear-gradient(90deg,#fff 0%, #fbfdff 100%);box-shadow:0 1px 0 rgba(0,0,0,0.04);}
  header.appHeader h1{margin:0;font-size:22px;}
  main.appMain{padding:14px;flex:1;display:grid;grid-template-rows: repeat(2, 1fr);grid-template-columns: repeat(5, 1fr);gap:14px;}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(20,30,60,0.04);display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;}
  .card h3{margin:0 0 10px 0;font-size:16px;}
  .card .placeholder{flex:1;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:14px;}
  .card.disabled{opacity:1;}
  /* å¡ç‰‡ç•Œé¢ï¼ˆè·³è½¬åæ˜¾ç¤ºï¼‰ */
  .panel{position:fixed;inset:0;background:#f7fafc;display:flex;flex-direction:column;z-index:30;padding:18px;overflow:auto;}
  .panelHeader{display:flex;align-items:center;gap:12px;}
  .backBtn{padding:8px 12px;border-radius:8px;border:0;background:#eee;cursor:pointer;}
  .panelBody{margin-top:12px;flex:1;display:flex;flex-direction:column;gap:12px;}
  /* è®¡ç®—å™¨æ ·å¼ï¼ˆç”¨äº card1 çš„ç•Œé¢ï¼‰ */
  .calcWrap{max-width:720px;width:100%;margin:0 auto;display:flex;flex-direction:column;gap:12px;}
  .display{min-height:56px;border-radius:8px;border:1px solid #e6ecf8;padding:8px 12px;font-size:22px;background:#fff;display:flex;align-items:center;justify-content:flex-end;word-break:break-all;}
  .pad{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:auto;}
  .btn{padding:14px;border-radius:10px;border:0;font-size:18px;cursor:pointer;background:#f2f6ff;user-select:none;}
  .btn.op{background:#fff7e6;}
  .btn.equal{background:var(--accent);color:#fff;grid-column:span 2;}
  .btn:active{transform:translateY(1px);}
  .note{color:var(--muted);font-size:14px;margin-top:12px;text-align:center;}
  /* è¡¨å•ç®€åŒ–æ ·å¼ */
  .formRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .formRow input[type="number"], .formRow input[type="text"], .formRow select, textarea{
    padding:8px;border-radius:8px;border:1px solid #e6ecf8;font-size:14px;
  }
  .table{width:100%;border-collapse:collapse;}
  .table th, .table td{padding:8px;border:1px solid #eef2f7;text-align:left;}
  .small{font-size:13px;color:var(--muted);}
  /* å“åº” */
  @media (max-width:900px){
    main.appMain{grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(5,1fr);}
    .loginBox{width:92%;}
  }
</style>
</head>
<body>

<!-- ç™»å½•è§†å›¾ -->
<div id="loginWrap">
  <div class="loginBox" id="loginBox">
    <h2>è¯·è¾“å…¥å¯†ç ä»¥è¿›å…¥</h2>
    <input id="initialPwd" type="password" placeholder="å¯†ç ">
    <div class="row">
      <button id="loginBtn">è¿›å…¥</button>
    </div>

    <!-- æ”¾åœ¨å¯†ç è¾“å…¥ä¸‹é¢ï¼šè¯·è´­ä¹°ç§˜é’¥ï¼ˆä»…æç¤ºï¼‰ -->
    <div class="purchaseRow" aria-hidden="false">
      <span>è¯·è´­ä¹°ç§˜é’¥</span>
      <span style="font-size:18px;">ğŸ’°</span>
    </div>
  </div>
</div>

<!-- ä¸»åº”ç”¨ï¼ˆåˆå§‹éšè—ï¼‰ -->
<div id="app" class="app" style="display:none;">
  <header class="appHeader"><h1>XX è®¡ç®—å™¨åˆé›†</h1></header>

  <main class="appMain" id="grid">
    <!-- å¡ç‰‡ 1..10 -->
    <div class="card" onclick="openCard('card1')">
      <h3>1. æ™®é€šè®¡ç®—å™¨</h3>
      <div class="placeholder">ç‚¹å‡»è¿›å…¥ä½¿ç”¨æ™®é€šè®¡ç®—å™¨</div>
    </div>

    <div class="card" onclick="openCard('card2')">
      <h3>2. é‡‘èè®¡ç®—å™¨</h3>
      <div class="placeholder">è´·æ¬¾/æŒ‰æ­æœˆä¾›è®¡ç®—</div>
    </div>

    <div class="card" onclick="openCard('card3')">
      <h3>3. æŠ•èµ„å›æŠ¥</h3>
      <div class="placeholder">æœªæ¥å€¼ & å¹´åŒ–æ”¶ç›Šç‡</div>
    </div>

    <div class="card" onclick="openCard('card4')">
      <h3>4. æ€§ä»·æ¯”</h3>
      <div class="placeholder">å¤šé¡¹æ€§ä»·æ¯”æ’åº</div>
    </div>

    <div class="card" onclick="openCard('card5')">
      <h3>5. åˆ©ç‡æ¢ç®—</h3>
      <div class="placeholder">åä¹‰åˆ©ç‡ â†” æœ‰æ•ˆå¹´åˆ©ç‡</div>
    </div>

    <div class="card" onclick="openCard('card6')">
      <h3>6. å¾®ç§¯åˆ†ï¼ˆç§¯åˆ†ï¼‰</h3>
      <div class="placeholder">æ•°å€¼å®šç§¯åˆ†</div>
    </div>

    <div class="card" onclick="openCard('card7')">
      <h3>7. å¾®ç§¯åˆ†ï¼ˆå¯¼æ•°ï¼‰</h3>
      <div class="placeholder">æ•°å€¼æ±‚å¯¼</div>
    </div>

    <div class="card" onclick="openCard('card8')">
      <h3>8. ä»£æ•°/æ–¹ç¨‹æ±‚è§£</h3>
      <div class="placeholder">ä¸€å…ƒä¸€æ¬¡/äºŒæ¬¡æ–¹ç¨‹</div>
    </div>

    <div class="card" onclick="openCard('card9')">
      <h3>9. ä¸‰è§’å‡½æ•°</h3>
      <div class="placeholder">è§’åº¦/å¼§åº¦ã€ä¸‰è§’å€¼</div>
    </div>

    <div class="card" onclick="openCard('card10')">
      <h3>10. ç»Ÿè®¡/æ¦‚ç‡</h3>
      <div class="placeholder">å‡å€¼/æ–¹å·®/äºŒé¡¹åˆ†å¸ƒ</div>
    </div>
  </main>
</div>

<!-- å¡ç‰‡ç‹¬ç«‹ç•Œé¢ï¼ˆpanelï¼‰â€”â€” åˆå§‹éšè— -->
<div id="panel" class="panel" style="display:none;">
  <div class="panelHeader">
    <button class="backBtn" onclick="closePanel()">â† è¿”å›</button>
    <h2 id="panelTitle" style="margin:0;font-size:18px;"></h2>
  </div>
  <div class="panelBody" id="panelBody">
    <!-- å†…å®¹ç”± JS æ³¨å…¥ -->
  </div>
</div>

<script>
  // ========== åŸºæœ¬ç«™ç‚¹/ç™»å½•/å¯¼èˆª ==========
  const sitePassword = "bebigandstrong";
  let loggedIn = false;
  let activeCard = null;

  document.getElementById('loginBtn').addEventListener('click', tryLogin);
  document.getElementById('initialPwd').addEventListener('keydown', (e)=> { if(e.key==='Enter') tryLogin(); });

  function tryLogin(){
    const v = document.getElementById('initialPwd').value;
    if(v === sitePassword){
      loggedIn = true;
      document.getElementById('loginWrap').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      document.getElementById('initialPwd').value = '';
    } else {
      alert('å¯†ç é”™è¯¯ï¼');
    }
  }

  function openCard(id){
    if(!loggedIn){ alert('è¯·å…ˆè¾“å…¥å¯†ç è¿›å…¥ç½‘ç«™ã€‚'); return; }
    activeCard = id;
    document.getElementById('panelTitle').textContent = cardTitle(id);
    document.getElementById('panelBody').innerHTML = panelContentHTML(id);
    document.getElementById('panel').style.display = 'flex';
    // focus first input
    setTimeout(()=> {
      const el = document.querySelector('#panel input, #panel textarea, #panel button');
      if(el) el.focus();
    }, 50);
    // reset any per-card state if needed
    if(id==='card1'){ calc_expr = ''; updateCalcDisp(); }
    if(id==='card6'){ integral_expr=''; document.getElementById('panelBody') && updateIntegralPreview && updateIntegralPreview(); }
    if(id==='card7'){ derivative_expr=''; }
  }

  function closePanel(){
    activeCard = null;
    document.getElementById('panel').style.display = 'none';
    document.getElementById('panelBody').innerHTML = '';
  }

  function cardTitle(id){
    const map={
      card1:'æ™®é€šè®¡ç®—å™¨', card2:'é‡‘èè®¡ç®—å™¨', card3:'æŠ•èµ„å›æŠ¥',
      card4:'æ€§ä»·æ¯”', card5:'åˆ©ç‡æ¢ç®—', card6:'å¾®ç§¯åˆ†ï¼ˆç§¯åˆ†ï¼‰',
      card7:'å¾®ç§¯åˆ†ï¼ˆå¯¼æ•°ï¼‰', card8:'ä»£æ•°/æ–¹ç¨‹æ±‚è§£', card9:'ä¸‰è§’å‡½æ•°', card10:'ç»Ÿè®¡/æ¦‚ç‡'
    };
    return map[id]||'è®¡ç®—å™¨';
  }

  // ========= æ¯ä¸ªå¡ç‰‡çš„ HTML å†…å®¹ ==========
  function panelContentHTML(id){
    if(id==='card1') return card1HTML();
    if(id==='card2') return card2HTML();
    if(id==='card3') return card3HTML();
    if(id==='card4') return card4HTML();
    if(id==='card5') return card5HTML();
    if(id==='card6') return card6HTML();
    if(id==='card7') return card7HTML();
    if(id==='card8') return card8HTML();
    if(id==='card9') return card9HTML();
    if(id==='card10') return card10HTML();
    return '<div>æœªå®ç°</div>';
  }

  // ---------------- å¡ç‰‡1ï¼šæ™®é€šè®¡ç®—å™¨ ----------------
  function card1HTML(){
    return `
      <div class="calcWrap">
        <div id="calcDisplay" class="display">0</div>
        <div class="pad">
          <button class="btn" onclick="calcPress('7')">7</button>
          <button class="btn" onclick="calcPress('8')">8</button>
          <button class="btn" onclick="calcPress('9')">9</button>
          <button class="btn op" onclick="calcPress('/')">Ã·</button>

          <button class="btn" onclick="calcPress('4')">4</button>
          <button class="btn" onclick="calcPress('5')">5</button>
          <button class="btn" onclick="calcPress('6')">6</button>
          <button class="btn op" onclick="calcPress('*')">Ã—</button>

          <button class="btn" onclick="calcPress('1')">1</button>
          <button class="btn" onclick="calcPress('2')">2</button>
          <button class="btn" onclick="calcPress('3')">3</button>
          <button class="btn op" onclick="calcPress('-')">âˆ’</button>

          <button class="btn" onclick="calcPress('0')">0</button>
          <button class="btn" onclick="calcPress('.')">.</button>
          <button class="btn equal" onclick="calcCompute()">=</button>
          <button class="btn op" onclick="calcPress('+')">+</button>

          <button class="btn" style="grid-column:span 2;" onclick="calcClear()">C</button>
          <button class="btn" onclick="calcBack()">âŒ«</button>
          <button class="btn" onclick="calcToggleSign()">Â±</button>
        </div>
        <div class="note">æ”¯æŒé”®ç›˜ï¼šæ•°å­—ã€+ - * /ã€Enter=ã€Backspace=åˆ é™¤ã€Esc=æ¸…é™¤</div>
      </div>
    `;
  }

  // æ™®é€šè®¡ç®—å™¨é€»è¾‘ï¼ˆä»…åœ¨æ‰“å¼€ card1 æ—¶ç”Ÿæ•ˆï¼‰
  let calc_expr = '';
  function updateCalcDisp(){
    const el = document.getElementById('calcDisplay');
    if(!el) return;
    el.textContent = calc_expr === '' ? '0' : calc_expr;
  }
  function calcPress(ch){
    if(activeCard !== 'card1') return;
    if(calc_expr === '0' && ch !== '.') calc_expr = '';
    calc_expr += ch;
    updateCalcDisp();
  }
  function calcClear(){ if(activeCard!=='card1') return; calc_expr=''; updateCalcDisp(); }
  function calcBack(){ if(activeCard!=='card1') return; calc_expr = calc_expr.slice(0,-1); updateCalcDisp(); }
  function calcToggleSign(){
    if(activeCard!=='card1') return;
    try {
      const m = calc_expr.match(/(-?[0-9.]+)$/);
      if(m){
        const num = m[1]; const start = calc_expr.slice(0,m.index);
        const val = parseFloat(num);
        if(!isNaN(val)) calc_expr = start + ((-val).toString());
      } else calc_expr = '-';
    } catch(e){}
    updateCalcDisp();
  }
  function calcCompute(){
    if(activeCard!=='card1') return;
    if(calc_expr.trim()==='') return;
    const safe = /^[0-9+\-*/().\s]+$/;
    if(!safe.test(calc_expr)){ alert('è¡¨è¾¾å¼åŒ…å«ä¸å…è®¸çš„å­—ç¬¦'); return; }
    try{
      const jsExpr = calc_expr.replace(/Ã—/g,'*').replace(/Ã·/g,'/');
      const res = Function('"use strict";return ('+jsExpr+')')();
      calc_expr = (typeof res==='number' && isFinite(res)) ? String(res) : '0';
      updateCalcDisp();
    }catch(e){
      alert('è®¡ç®—é”™è¯¯ï¼š' + (e.message || e));
    }
  }

  // é”®ç›˜æ”¯æŒï¼ˆä»…åœ¨ card1 é¢æ¿æ‰“å¼€æ—¶ç”Ÿæ•ˆï¼‰
  window.addEventListener('keydown', function(e){
    if(!loggedIn) return;
    if(activeCard !== 'card1') return;
    const k = e.key;
    if((/^[0-9]$/.test(k)) || k==='.') { calcPress(k); e.preventDefault(); }
    else if(k==='+'||k==='-'||k==='*'||k==='/'){ calcPress(k); e.preventDefault(); }
    else if(k==='Enter'){ calcCompute(); e.preventDefault(); }
    else if(k==='Backspace'){ calcBack(); e.preventDefault(); }
    else if(k==='Escape'){ calcClear(); e.preventDefault(); }
  });

  // ---------------- å¡ç‰‡2ï¼šé‡‘èè®¡ç®—å™¨ï¼ˆè´·æ¬¾/æŒ‰æ­ï¼‰ ----------------
  function card2HTML(){
    return `
      <div style="max-width:720px;margin:0 auto;">
        <div class="formRow" style="gap:10px;flex-wrap:wrap;">
          <label>è´·æ¬¾æœ¬é‡‘ (å…ƒ): <input id="loanP" type="number" step="0.01" value="100000"></label>
          <label>å¹´åˆ©ç‡ (%) : <input id="loanR" type="number" step="0.0001" value="4.9"></label>
          <label>æœŸé™ (å¹´) : <input id="loanY" type="number" step="1" value="20"></label>
          <label>è¿˜æ¬¾é¢‘ç‡:
            <select id="loanFreq">
              <option value="12">æŒ‰æœˆ</option>
              <option value="1">æŒ‰å¹´</option>
            </select>
          </label>
          <button class="btn" onclick="calcLoan()">è®¡ç®—</button>
        </div>
        <div id="loanResult" style="margin-top:12px;"></div>
        <div class="small" style="margin-top:8px;">è¯´æ˜ï¼šç­‰é¢æœ¬æ¯è®¡ç®—å…¬å¼å·²ä½¿ç”¨å¸¸è§å…¬å¼ã€‚</div>
      </div>
    `;
  }
  function calcLoan(){
    if(activeCard!=='card2') return;
    const P = parseFloat(document.getElementById('loanP').value) || 0;
    const r_ann = parseFloat(document.getElementById('loanR').value) / 100 || 0;
    const years = parseFloat(document.getElementById('loanY').value) || 0;
    const m = parseInt(document.getElementById('loanFreq').value) || 12;
    if(P<=0 || years<=0){ alert('è¯·è¾“å…¥æ­£ç¡®çš„æœ¬é‡‘ä¸å¹´é™'); return; }
    const n = years * m;
    const r = r_ann / m;
    let monthly = 0;
    if(r === 0) monthly = P / n;
    else monthly = P * r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1);
    const total = monthly * n;
    const interest = total - P;
    document.getElementById('loanResult').innerHTML = `
      <table class="table">
        <tr><th>æ¯æœŸè¿˜æ¬¾</th><td>${monthly.toFixed(2)}</td></tr>
        <tr><th>æœŸæ•° (n)</th><td>${n}</td></tr>
        <tr><th>æ€»è¿˜æ¬¾</th><td>${total.toFixed(2)}</td></tr>
        <tr><th>æ”¯ä»˜åˆ©æ¯</th><td>${interest.toFixed(2)}</td></tr>
      </table>
    `;
  }

  // ---------------- å¡ç‰‡3ï¼šæŠ•èµ„å›æŠ¥ï¼ˆFV & CAGRï¼‰ ----------------
  function card3HTML(){
    return `
      <div style="max-width:720px;margin:0 auto;">
        <div class="formRow" style="gap:8px;flex-wrap:wrap;">
          <label>åˆå§‹æœ¬é‡‘ PV : <input id="invPV" type="number" value="10000"></label>
          <label>å¹´åˆ©ç‡ (%) : <input id="invR" type="number" step="0.0001" value="6"></label>
          <label>å¹´æ•° (å¹´) : <input id="invY" type="number" value="10"></label>
          <label>æ¯æœŸè¿½åŠ  PMT : <input id="invPMT" type="number" value="0"></label>
          <label>æ¯å¹´æœŸæ•° (periods/year) : <input id="invPer" type="number" value="1"></label>
          <button class="btn" onclick="calcInvestment()">è®¡ç®—</button>
        </div>
        <div id="invResult" style="margin-top:12px;"></div>
        <div class="small" style="margin-top:8px;">è¯´æ˜ï¼šFV é‡‡ç”¨å¸¸è§å¹´é‡‘å…¬å¼ï¼›CAGR æ ¹æ®å¹´æ•°è®¡ç®—å¤åˆå¹´åŒ–å¢é•¿ç‡ã€‚</div>
      </div>
    `;
  }
  function calcInvestment(){
    if(activeCard!=='card3') return;
    const PV = parseFloat(document.getElementById('invPV').value) || 0;
    const r_ann = (parseFloat(document.getElementById('invR').value)||0)/100;
    const years = parseFloat(document.getElementById('invY').value) || 0;
    const PMT = parseFloat(document.getElementById('invPMT').value) || 0;
    const per = parseInt(document.getElementById('invPer').value) || 1;
    const n = years * per;
    const r = r_ann / per;
    let FV = 0;
    if(r === 0) FV = PV + PMT * n;
    else FV = PV * Math.pow(1 + r, n) + PMT * ( (Math.pow(1+r,n) - 1) / r );
    const CAGR = (PV > 0) ? (Math.pow(FV / PV, 1/years) - 1) : null;
    document.getElementById('invResult').innerHTML = `
      <table class="table">
        <tr><th>æœªæ¥å€¼ (FV)</th><td>${FV.toFixed(2)}</td></tr>
        <tr><th>å¹´æ•°</th><td>${years}</td></tr>
        <tr><th>å¤åˆå¹´åŒ–æ”¶ç›Šç‡ (CAGR)</th><td>${CAGR===null? 'N/A' : (CAGR*100).toFixed(4)+'%'}</td></tr>
      </table>
    `;
  }

  // ---------------- å¡ç‰‡4ï¼šæ€§ä»·æ¯” ----------------
  // å…è®¸ç”¨æˆ·æ·»åŠ å¤šä¸ªé¡¹ç›®ï¼šåç§°ã€æ€§èƒ½åˆ†ã€ä»·æ ¼ï¼›è®¡ç®— æ€§ä»·æ¯” = performance / priceï¼ˆå¯ä¹˜ä»¥ 1000 ä»¥ä¾¿é˜…è¯»ï¼‰ï¼Œå¹¶æ’åºæ˜¾ç¤º
  function card4HTML(){
    return `
      <div style="max-width:900px;margin:0 auto;">
        <div class="formRow" style="gap:8px;">
          <input id="itemName" placeholder="åç§°" type="text">
          <input id="itemScore" placeholder="æ€§èƒ½åˆ† (æ•°å€¼)" type="number" step="0.01">
          <input id="itemPrice" placeholder="ä»·æ ¼ (å…ƒ)" type="number" step="0.01">
          <button class="btn" onclick="addPriceItem()">æ·»åŠ </button>
          <button class="btn" onclick="clearPriceItems()">æ¸…ç©º</button>
        </div>
        <div id="priceList" style="margin-top:12px;"></div>
        <div class="small" style="margin-top:8px;">è¯´æ˜ï¼šæ€§ä»·æ¯”è®¡ç®—ä¸º performance / priceï¼ˆæ•°å€¼è¶Šå¤§è¶Šåˆ’ç®—ï¼‰ã€‚</div>
      </div>
    `;
  }

  let priceItems = [];
  function addPriceItem(){
    if(activeCard!=='card4') return;
    const name = (document.getElementById('itemName').value||'æœªå‘½å').trim();
    const score = parseFloat(document.getElementById('itemScore').value) || 0;
    const price = parseFloat(document.getElementById('itemPrice').value) || 0;
    if(price <= 0){ alert('ä»·æ ¼éœ€å¤§äº 0'); return; }
    priceItems.push({name,score,price,ratio: score / price});
    renderPriceItems();
    document.getElementById('itemName').value=''; document.getElementById('itemScore').value=''; document.getElementById('itemPrice').value='';
  }
  function renderPriceItems(){
    if(activeCard!=='card4') return;
    const out = priceItems.slice().sort((a,b)=> b.ratio - a.ratio)
      .map((it,idx)=> `<tr><td>${idx+1}</td><td>${escapeHtml(it.name)}</td><td>${it.score}</td><td>${it.price.toFixed(2)}</td><td>${(it.ratio).toFixed(6)}</td></tr>`).join('');
    document.getElementById('priceList').innerHTML = `
      <table class="table">
        <thead><tr><th>#</th><th>åç§°</th><th>æ€§èƒ½åˆ†</th><th>ä»·æ ¼</th><th>æ€§ä»·æ¯” (å¾—åˆ†/å…ƒ)</th></tr></thead>
        <tbody>${out}</tbody>
      </table>
    `;
  }
  function clearPriceItems(){ priceItems=[]; if(activeCard==='card4') document.getElementById('priceList').innerHTML=''; }

  // ---------------- å¡ç‰‡5ï¼šåˆ©ç‡æ¢ç®— ----------------
  function card5HTML(){
    return `
      <div style="max-width:720px;margin:0 auto;">
        <div class="formRow" style="gap:8px;align-items:center;">
          <label>å¹´åˆ©ç‡ï¼ˆ%ï¼‰: <input id="rateInput" type="number" step="0.0001" value="6"></label>
          <label>å¤åˆ©é¢‘ç‡ m: <input id="rateM" type="number" value="12"></label>
          <button class="btn" onclick="convertRate()">æ¢ç®—</button>
        </div>
        <div id="rateResult" style="margin-top:12px;"></div>
        <div class="small" style="margin-top:8px;">è¯´æ˜ï¼šæœ‰æ•ˆå¹´åˆ©ç‡ (EAR) = (1 + r_nom/m)^m - 1ã€‚å¯ä»¥åœ¨è¾“å…¥åä¹‰å¹´åˆ©ç‡ä¸ m åæ¢ç®—ã€‚</div>
      </div>
    `;
  }
  function convertRate(){
    if(activeCard!=='card5') return;
    const r_nom = (parseFloat(document.getElementById('rateInput').value)||0) / 100;
    const m = parseInt(document.getElementById('rateM').value) || 1;
    const EAR = Math.pow(1 + r_nom / m, m) - 1;
    // åç®—åä¹‰åˆ©ç‡ï¼ˆè‹¥ç»™å®š EARï¼‰
    const js = `
      <table class="table">
        <tr><th>åä¹‰å¹´åˆ©ç‡ (r_nom)</th><td>${(r_nom*100).toFixed(6)}%</td></tr>
        <tr><th>å¤åˆ©é¢‘ç‡ m</th><td>${m}</td></tr>
        <tr><th>æœ‰æ•ˆå¹´åˆ©ç‡ (EAR)</th><td>${(EAR*100).toFixed(6)}%</td></tr>
      </table>
    `;
    document.getElementById('rateResult').innerHTML = js;
  }

  // ---------------- å¡ç‰‡6ï¼šå¾®ç§¯åˆ†ï¼ˆç§¯åˆ†ï¼Œæ•°å€¼ï¼‰ ----------------
  // æ”¯æŒç”¨æˆ·è¾“å…¥ f(x)ï¼ŒåŒºé—´ [a,b]ï¼Œnï¼ˆåˆ†å‰²æ•°ï¼Œå¿…é¡»ä¸ºå¶æ•°ç”¨äº Simpsonï¼‰
  function card6HTML(){
    return `
      <div style="max-width:900px;margin:0 auto;">
        <div class="formRow" style="gap:8px;align-items:center;">
          <label>å‡½æ•° f(x): <input id="intFunc" type="text" value="sin(x)"></label>
          <label>a: <input id="intA" type="number" value="0"></label>
          <label>b: <input id="intB" type="number" value="3.1416"></label>
          <label>åˆ†å‰² n (å¶æ•°): <input id="intN" type="number" value="1000"></label>
          <button class="btn" onclick="calcIntegral()">è®¡ç®—å®šç§¯åˆ†</button>
        </div>
        <div id="intResult" style="margin-top:12px;"></div>
        <div class="small" style="margin-top:8px;">å‡½æ•°è¡¨è¾¾å¼ç¤ºä¾‹ï¼š sin(x), cos(x), exp(x), x^2, log(x), sqrt(x)ã€‚^ ä¼šè‡ªåŠ¨è½¬ä¸ºå¹‚è¿ç®—ã€‚</div>
      </div>
    `;
  }

  // è¾…åŠ©ï¼šå®‰å…¨æ£€æŸ¥å¹¶åˆ›å»ºå‡½æ•° f(x)
  function buildFunctionFromString(s){
    // å…è®¸çš„å­—ç¬¦ï¼ˆæ•°å­—ã€ç©ºæ ¼ã€è¿ç®—ç¬¦ã€å­—æ¯ã€_ã€å°æ•°ç‚¹ã€æ‹¬å·ã€é€—å·ã€^ï¼‰
    // åªå…è®¸ a--z A--Z æ•°å­—å’Œå¸¸ç”¨è¿ç®—ç¬¦ï¼Œä»¥å‡å°‘é£é™©
    const allowed = /^[0-9a-zA-Z+\-*/().,\s^%]*$/;
    if(!allowed.test(s)) return null;
    // æ›¿æ¢ ^ -> **
    const expr = s.replace(/\^/g,'**');
    // é™åˆ¶éƒ¨åˆ†å±é™©å­—ï¼ˆå¦‚ while, for, Function, window, document, eval, fetch ç­‰ï¼‰
    const forbidden = /(window|document|eval|Function|fetch|XMLHttpRequest|while|for|=>|process|require)/i;
    if(forbidden.test(expr)) return null;
    // åˆ›å»ºå‡½æ•°ï¼ŒMath.* å‡½æ•°å¯ç›´æ¥è°ƒç”¨ï¼ˆåœ¨è¡¨è¾¾å¼é‡Œå†™ Math.sin ä¹Ÿè¡Œï¼‰ï¼Œä½†æˆ‘ä»¬ä¹Ÿå…è®¸å†™ sin(x) -> ä½¿ç”¨ withMath wrapper
    try {
      // Create a safe wrapper that exposes Math functions as local variables
      const fn = new Function('x', `
        const {sin,cos,tan,asin,acos,atan,exp,log,sqrt,pow,abs,PI,e,round,floor,ceil} = Math;
        return (${expr});
      `);
      // test it
      const test = fn(1);
      return fn;
    } catch(e){
      return null;
    }
  }

  function calcIntegral(){
    if(activeCard!=='card6') return;
    const s = (document.getElementById('intFunc').value||'').trim();
    const a = parseFloat(document.getElementById('intA').value);
    const b = parseFloat(document.getElementById('intB').value);
    let n = parseInt(document.getElementById('intN').value) || 100;
    if(isNaN(a)||isNaN(b)){ alert('è¯·è¾“å…¥æ­£ç¡®åŒºé—´'); return; }
    if(n < 2) n = 2;
    if(n % 2 === 1) n++; // Simpson è¦å¶æ•°
    const fn = buildFunctionFromString(s);
    if(!fn){ alert('å‡½æ•°è§£æå¤±è´¥æˆ–åŒ…å«ä¸å…è®¸çš„å­—ç¬¦'); return; }
    // Simpson's rule
    const h = (b - a) / n;
    let sum = 0;
    try {
      for(let i=0;i<=n;i++){
        const x = a + i*h;
        const fx = Number(fn(x));
        if(!isFinite(fx)){ alert('å‡½æ•°åœ¨ç§¯åˆ†åŒºé—´å­˜åœ¨éæœ‰é™å€¼'); return; }
        const coef = (i===0 || i===n) ? 1 : (i%2===0 ? 2 : 4);
        sum += coef * fx;
      }
      const integral = (h/3) * sum;
      document.getElementById('intResult').innerHTML = `<div class="small">ç§¯åˆ†ç»“æœï¼ˆæ•°å€¼è¿‘ä¼¼ï¼‰: <strong>${integral}</strong></div>`;
    } catch(e){
      alert('å‡½æ•°è®¡ç®—å‡ºé”™: ' + (e.message||e));
    }
  }

  // ---------------- å¡ç‰‡7ï¼šå¾®ç§¯åˆ†ï¼ˆå¯¼æ•°ï¼‰ ----------------
  function card7HTML(){
    return `
      <div style="max-width:720px;margin:0 auto;">
        <div class="formRow" style="gap:8px;align-items:center;">
          <label>å‡½æ•° f(x): <input id="derivFunc" value="sin(x)" type="text"></label>
          <label>ç‚¹ x0: <input id="derivX0" value="0.5" type="number"></label>
          <label>h (å¯é€‰å°é‡): <input id="derivH" value="1e-6" type="number" step="any"></label>
          <button class="btn" onclick="calcDerivative()">è®¡ç®—å¯¼æ•°</button>
        </div>
        <div id="derivResult" style="margin-top:12px;"></div>
        <div class="small" style="margin-top:8px;">è¯´æ˜ï¼šä½¿ç”¨ä¸­å¿ƒå·®åˆ†æ³•ä¼°ç®— f'(x0) â‰ˆ (f(x0+h)-f(x0-h))/(2h)ã€‚</div>
      </div>
    `;
  }

  let derivative_expr = '';
  function calcDerivative(){
    if(activeCard!=='card7') return;
    const s = (document.getElementById('derivFunc').value||'').trim();
    const x0 = parseFloat(document.getElementById('derivX0').value);
    let h = parseFloat(document.getElementById('derivH').value);
    if(isNaN(x0)) { alert('è¯·è¾“å…¥æ­£ç¡® x0'); return; }
    if(isNaN(h) || h <= 0) h = 1e-6;
    const fn = buildFunctionFromString(s);
    if(!fn){ alert('å‡½æ•°è§£æå¤±è´¥æˆ–åŒ…å«ä¸å…è®¸çš„å­—ç¬¦'); return; }
    try {
      const y1 = Number(fn(x0 + h));
      const y2 = Number(fn(x0 - h));
      const d = (y1 - y2) / (2*h);
      document.getElementById('derivResult').innerHTML = `<div class="small">f'(${x0}) â‰ˆ <strong>${d}</strong></div>`;
    } catch(e){
      alert('å‡½æ•°è®¡ç®—å‡ºé”™: ' + (e.message||e));
    }
  }

  // ---------------- å¡ç‰‡8ï¼šä»£æ•°/æ–¹ç¨‹æ±‚è§£ ----------------
  function card8HTML(){
    return `
      <div style="max-width:720px;margin:0 auto;">
        <h3>æ±‚è§£ ax^2 + bx + c = 0 ï¼ˆè‹¥ a=0 åˆ™é€€åŒ–ä¸ºä¸€æ¬¡æ–¹ç¨‹ bx + c = 0ï¼‰</h3>
        <div class="formRow" style="gap:8px;align-items:center;">
          <label>a: <input id="eqA" type="number" value="1"></label>
          <label>b: <input id="eqB" type="number" value="0"></label>
          <label>c: <input id="eqC" type="number" value="-1"></label>
          <button class="btn" onclick="solveQuadratic()">æ±‚è§£</button>
        </div>
        <div id="eqResult" style="margin-top:12px;"></div>
        <div class="small" style="margin-top:8px;">æ”¯æŒå¤æ ¹æ˜¾ç¤ºã€‚</div>
      </div>
    `;
  }
  function solveQuadratic(){
    if(activeCard!=='card8') return;
    const a = parseFloat(document.getElementById('eqA').value) || 0;
    const b = parseFloat(document.getElementById('eqB').value) || 0;
    const c = parseFloat(document.getElementById('eqC').value) || 0;
    if(Math.abs(a) < 1e-12){
      // linear bx + c = 0
      if(Math.abs(b) < 1e-12){ document.getElementById('eqResult').innerHTML = '<div>æ— è§£æˆ–æ— é™å¤šè§£ (a=b=0)</div>'; return; }
      const x = -c / b;
      document.getElementById('eqResult').innerHTML = `<div class="small">ä¸€æ¬¡æ–¹ç¨‹è§£: x = <strong>${x}</strong></div>`;
      return;
    }
    const D = b*b - 4*a*c;
    if(D >= 0){
      const r1 = (-b + Math.sqrt(D)) / (2*a);
      const r2 = (-b - Math.sqrt(D)) / (2*a);
      document.getElementById('eqResult').innerHTML = `<div class="small">å®æ ¹ï¼šx1=${r1}, x2=${r2}</div>`;
    } else {
      const real = (-b)/(2*a);
      const im = Math.sqrt(-D)/(2*a);
      document.getElementById('eqResult').innerHTML = `<div class="small">å¤æ ¹ï¼šx1=${real.toFixed(6)} + ${im.toFixed(6)}i , x2=${real.toFixed(6)} - ${im.toFixed(6)}i</div>`;
    }
  }

  // ---------------- å¡ç‰‡9ï¼šä¸‰è§’å‡½æ•° ----------------
  function card9HTML(){
    return `
      <div style="max-width:720px;margin:0 auto;">
        <div class="formRow" style="gap:8px;align-items:center;">
          <label>è§’åº¦/å¼§åº¦è¾“å…¥: <input id="triAngle" type="number" value="30"></label>
          <label>
            å•ä½:
            <select id="triUnit">
              <option value="deg">åº¦ï¼ˆdegï¼‰</option>
              <option value="rad">å¼§åº¦ï¼ˆradï¼‰</option>
            </select>
          </label>
          <button class="btn" onclick="calcTrig()">è®¡ç®—</button>
        </div>
        <div id="triResult" style="margin-top:12px;"></div>
        <div class="small" style="margin-top:8px;">å¯å¾—åˆ° sin / cos / tan åŠåå‡½æ•° (arcsin ç­‰)ã€‚</div>
      </div>
    `;
  }
  function calcTrig(){
    if(activeCard!=='card9') return;
    const v = parseFloat(document.getElementById('triAngle').value) || 0;
    const unit = document.getElementById('triUnit').value;
    const rad = (unit==='deg') ? v * Math.PI / 180 : v;
    const s = Math.sin(rad), c = Math.cos(rad);
    let t = null;
    if(Math.abs(c) > 1e-12) t = s / c;
    const asin_v = (Math.abs(s) <= 1) ? Math.asin(s) : NaN;
    const acos_v = (Math.abs(c) <= 1) ? Math.acos(c) : NaN;
    const atan_v = Math.atan2(s,c);
    document.getElementById('triResult').innerHTML = `
      <table class="table">
        <tr><th>sin</th><td>${s}</td></tr>
        <tr><th>cos</th><td>${c}</td></tr>
        <tr><th>tan</th><td>${t===null? 'æ— å®šä¹‰' : t}</td></tr>
        <tr><th>asin(sin)</th><td>${isNaN(asin_v)? 'N/A' : asin_v + ' rad'}</td></tr>
        <tr><th>acos(cos)</th><td>${isNaN(acos_v)? 'N/A' : acos_v + ' rad'}</td></tr>
        <tr><th>atan2</th><td>${atan_v} rad</td></tr>
      </table>
    `;
  }

  // ---------------- å¡ç‰‡10ï¼šç»Ÿè®¡/æ¦‚ç‡ ----------------
  function card10HTML(){
    return `
      <div style="max-width:900px;margin:0 auto;">
        <h3>æè¿°ç»Ÿè®¡</h3>
        <div class="formRow" style="gap:8px;align-items:center;">
          <textarea id="statsData" placeholder="è¾“å…¥ä¸€åˆ—æ•°å­—ï¼Œç”¨é€—å·æˆ–ç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼š1,2,3,4,5" style="width:100%;min-height:80px;"></textarea>
        </div>
        <div class="formRow" style="gap:8px;align-items:center;">
          <button class="btn" onclick="calcStats()">è®¡ç®—</button>
        </div>
        <div id="statsResult" style="margin-top:12px;"></div>

        <h3 style="margin-top:16px;">äºŒé¡¹åˆ†å¸ƒ (Binomial)</h3>
        <div class="formRow" style="gap:8px;align-items:center;">
          <label>è¯•éªŒæ¬¡æ•° n: <input id="bn" type="number" value="10"></label>
          <label>æˆåŠŸæ¬¡æ•° k: <input id="bk" type="number" value="3"></label>
          <label>å•æ¬¡æˆåŠŸæ¦‚ç‡ p: <input id="bp" type="number" step="0.01" value="0.5"></label>
          <button class="btn" onclick="calcBinomial()">è®¡ç®— P(X=k)</button>
        </div>
        <div id="binRes" style="margin-top:12px;"></div>
      </div>
    `;
  }

  function parseNumberList(str){
    if(!str) return [];
    const parts = str.split(/[\s,;]+/).filter(Boolean);
    const nums = parts.map(s=> parseFloat(s)).filter(n=> !isNaN(n));
    return nums;
  }

  function calcStats(){
    if(activeCard!=='card10') return;
    const arr = parseNumberList(document.getElementById('statsData').value);
    if(arr.length===0){ alert('è¯·è¾“å…¥ä¸€ç»„æ•°å­—'); return; }
    const n = arr.length;
    const mean = arr.reduce((a,b)=>a+b,0)/n;
    const sorted = arr.slice().sort((a,b)=>a-b);
    const median = (n%2===1) ? sorted[(n-1)/2] : (sorted[n/2 -1] + sorted[n/2]) / 2;
    const variance = arr.reduce((a,b)=> a + Math.pow(b-mean,2), 0) / n; // population variance
    const std = Math.sqrt(variance);
    // mode: simplest approach
    const freq = {}; arr.forEach(x=> freq[x] = (freq[x]||0)+1);
    const maxFreq = Math.max(...Object.values(freq));
    const modes = Object.keys(freq).filter(k=> freq[k]===maxFreq).map(Number);
    document.getElementById('statsResult').innerHTML = `
      <table class="table">
        <tr><th>æ ·æœ¬å¤§å° n</th><td>${n}</td></tr>
        <tr><th>å‡å€¼ (mean)</th><td>${mean}</td></tr>
        <tr><th>ä¸­ä½æ•° (median)</th><td>${median}</td></tr>
        <tr><th>ä¼—æ•° (mode)</th><td>${modes.join(', ')}</td></tr>
        <tr><th>æ–¹å·® (population)</th><td>${variance}</td></tr>
        <tr><th>æ ‡å‡†å·® (population)</th><td>${std}</td></tr>
      </table>
    `;
  }

  function factorial(n){
    if(n<0) return NaN;
    if(n===0) return 1;
    let r=1;
    for(let i=1;i<=n;i++) r*=i;
    return r;
  }
  function comb(n,k){
    if(k<0 || k>n) return 0;
    // use multiplicative formula for integer safety
    k = Math.min(k, n-k);
    let num=1, den=1;
    for(let i=1;i<=k;i++){ num *= (n - (k - i)); den *= i; }
    return num / den;
  }

  function calcBinomial(){
    if(activeCard!=='card10') return;
    const n = parseInt(document.getElementById('bn').value) || 0;
    const k = parseInt(document.getElementById('bk').value) || 0;
    const p = parseFloat(document.getElementById('bp').value) || 0;
    if(n<0 || k<0 || p<0 || p>1){ alert('è¯·è¾“å…¥åˆç†å‚æ•°'); return; }
    // P(X=k) = C(n,k) p^k (1-p)^(n-k)
    const c = comb(n,k);
    const prob = c * Math.pow(p,k) * Math.pow(1-p, n-k);
    document.getElementById('binRes').innerHTML = `<div class="small">P(X=${k}) = ${prob}</div>`;
  }

  // ---------- å°å·¥å…· ----------
  function escapeHtml(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

</script>
</body>
</html>


